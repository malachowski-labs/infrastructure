name: cleanup-snapshots

on:
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sundays at midnight
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Hetzner Cloud CLI
        uses: hetznercloud/setup-hcloud@v1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GC_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GC_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Fetch secrets
        id: secrets
        uses: google-github-actions/get-secretmanager-secrets@v3
        with:
          secrets: |
            infra-exec-hcloud-token:${{ vars.GC_PROJECT_ID }}/${{ vars.INFRA_EXECUTOR_HCLOUD_TOKEN_SECRET_NAME }}

      - name: Cleanup old snapshots
        env:
          HCLOUD_TOKEN: ${{ steps.secrets.outputs['infra-exec-hcloud-token'] }}
        run: |
          echo "Cleaning up old snapshots..."
          CUTOFF_DATE=$(date -d '7 days ago' --iso-8601=seconds)
          echo "Cutoff date: $CUTOFF_DATE"

          IMAGES=$(hcloud image list --type snapshot --output json | jq -r --arg cutoff "$CUTOFF_DATE" '.[] | select(.created < $cutoff) | .id')

          if [ -n "$IMAGES" ]; then
            for IMAGE_ID in $IMAGES; do
              echo "Deleting snapshot with ID: $IMAGE_ID"
              hcloud image delete "$IMAGE_ID"
            done
          else
            echo "No old snapshots to delete."
          fi

